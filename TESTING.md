# Testing Guide

This document describes how to run tests for the Trilingual Dictionary project.

## Test Coverage

### Go Core Library

Located in `core/` with test files alongside source files:

- **detector_test.go** - Language detection tests
  - ASCII/English detection
  - Japanese (Hiragana, Katakana, Kanji) detection
  - Chinese/Ambiguous detection
  - Unicode range boundary tests
  - Edge cases (empty, whitespace, mixed)

- **ranker_test.go** - Ranking algorithm tests
  - Common vs uncommon word ranking
  - Frequency rank ordering
  - Word length tie-breaking
  - NULL frequency handling
  - Score calculation validation

- **query_test.go** - Triangulation logic tests
  - English → Japanese + Chinese
  - Japanese → English + Chinese (pivot)
  - Chinese → English + Japanese (pivot)
  - Ambiguous input handling
  - Output validation

### TypeScript Web Service

Located in `web/src/app/services/`:

- **dictionary.service.spec.ts** - Service tests
  - Language detection (EN/JA/ZH/ambiguous)
  - Unicode range detection
  - Ranking algorithm
  - Score calculation
  - Metadata construction
  - Audio info generation

### iOS (Swift) - Not Yet Implemented

Planned tests:
- Language detection tests
- Database query tests
- Output construction tests

## Running Tests

### Go Tests

Run all tests:
```bash
cd core
go test ./...
```

Run tests with coverage:
```bash
go test -cover ./...
```

Run tests with verbose output:
```bash
go test -v ./...
```

Run specific package tests:
```bash
go test ./detector
go test ./ranker
go test ./query
```

Run with coverage report:
```bash
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

### TypeScript Tests

**Note:** Angular testing requires additional setup.

Run tests:
```bash
cd web
npm test
```

Run tests with coverage:
```bash
npm test -- --code-coverage
```

Run tests in watch mode:
```bash
npm test -- --watch
```

### iOS Tests

**Note:** iOS tests require Xcode.

Run tests:
```bash
cd ios
xcodebuild test -scheme TriDict -destination 'platform=iOS Simulator,name=iPhone 15'
```

Or use Xcode:
1. Open `ios/TriDict.xcodeproj`
2. Press `Cmd+U` to run tests

## Prerequisites

### For Go Tests

1. **Sample Database**: Some tests require the sample database
   ```bash
   cd data/sample
   python3 generate_samples.py
   ```

2. **Go Dependencies**:
   ```bash
   cd core
   go mod download
   ```

### For TypeScript Tests

1. **Node Dependencies**:
   ```bash
   cd web
   npm install
   ```

2. **Jasmine/Karma**: Already configured in Angular project

### For iOS Tests

1. **Xcode** (version 15+)
2. **SQLite Database**: Copy to iOS project
   ```bash
   cp data/sample/dictionary.db ios/TriDict/Resources/
   ```

## Test Data

### Sample Database

The tests use the sample database generated by:
```bash
cd data/sample
python3 generate_samples.py
```

This creates a 73KB database with:
- 20 English words
- 20 Japanese entries (kanji, reading, definitions)
- 20 Chinese entries (simplified, traditional, pinyin, definitions)
- Example sentences

### Full Database (Optional)

For integration testing with full data:
```bash
cd data
python3 download.py --extract
python3 ingest.py
```

This creates a ~25-30MB database with 300k+ entries.

## Continuous Integration

### GitHub Actions (Recommended)

Create `.github/workflows/test.yml`:

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test-go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.22'
      - name: Generate sample database
        run: |
          cd data/sample
          pip install -r ../requirements.txt
          python3 generate_samples.py
      - name: Run Go tests
        run: |
          cd core
          go test -v -cover ./...

  test-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: |
          cd web
          npm ci
      - name: Run tests
        run: |
          cd web
          npm test -- --browsers=ChromeHeadless --watch=false
```

## Coverage Goals

| Component | Target Coverage | Current Status |
|-----------|----------------|----------------|
| Go Core | >80% | 0% (tests created) |
| TypeScript | >70% | 0% (tests created) |
| iOS | >70% | 0% (not implemented) |

## Test Naming Conventions

### Go

- Test files: `*_test.go`
- Test functions: `TestFunctionName(t *testing.T)`
- Subtests: `t.Run("description", func(t *testing.T) {...})`

### TypeScript

- Test files: `*.spec.ts`
- Test suites: `describe('ComponentName', () => {...})`
- Test cases: `it('should do something', () => {...})`

### Swift

- Test files: `*Tests.swift`
- Test classes: `class ComponentNameTests: XCTestCase`
- Test methods: `func testFunctionality() { ... }`

## Debugging Tests

### Go

Enable verbose output and run single test:
```bash
go test -v -run TestDetectLanguage ./detector
```

Print debug info:
```go
t.Logf("Debug info: %v", value)
```

### TypeScript

Use `fdescribe` or `fit` to focus on specific tests:
```typescript
fdescribe('focused suite', () => {
  fit('focused test', () => {
    // Only this test runs
  });
});
```

### Swift

Use breakpoints in Xcode or:
```swift
print("Debug: \(value)")
```

## Common Issues

### Go Tests

**Issue**: `database not found`
**Solution**: Generate sample database first

**Issue**: `import cycle`
**Solution**: Reorganize imports to avoid circular dependencies

### TypeScript Tests

**Issue**: `Cannot find module 'sql.js'`
**Solution**: `npm install sql.js --save`

**Issue**: `Error: No provider for DictionaryService`
**Solution**: Add service to test module providers

### iOS Tests

**Issue**: `Database file not found in bundle`
**Solution**: Ensure dictionary.db is added to target in Xcode

## Next Steps

1. ✅ Create Go test files
2. ✅ Create TypeScript test files
3. ⚠️ Run and verify all tests pass
4. ⚠️ Measure coverage
5. ⚠️ Add iOS tests
6. ⚠️ Set up CI/CD pipeline
7. ⚠️ Add integration tests

## Resources

- [Go Testing Package](https://pkg.go.dev/testing)
- [Jasmine Documentation](https://jasmine.github.io/)
- [Angular Testing Guide](https://angular.io/guide/testing)
- [XCTest Documentation](https://developer.apple.com/documentation/xctest)
